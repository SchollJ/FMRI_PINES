{"title":"Run MRIQC in CRNL cluster","markdown":{"yaml":{"title":"Run MRIQC in CRNL cluster","author":"Anastasios Dadiotis","editor":"visual","toc":true,"format":{"html":{"code-tools":true,"self-contained":true}}},"headingText":"Set up","containsRefs":false,"markdown":"\n\nIn this preliminary step we setup and define our variables. Note from the code below, change the variable “subject” to the subject you are working on. The Tiger notation is C for controls and G for Gamblers, e.g. for the first control subject the notation is C01 and for the first gambler G01. The following procedure is to submit the job for one subject. (to be updated for more).\n\n``` bash\n# Standard variable for the Tiger study\nWD=/crnldata/psyr2/Anastasios/Tiger_fmri\nmy_study=Tiger\nsession_name=S01\n\n# change this to the subject you are working on\nsubject=XXX \n```\n\n# Submit the job\n\nRun the following code to submit the job to the cluster. This is for one subject only. There are scripts for multiple subjects via Slurm array jobs. (To be updated)\n\n``` bash\n# Submit the job\ncd ${WD}/${my_study}/code\nsbatch step4_mriqc.sh ${subject} ${session_name} ${WD} ${my_study}\nsqueue\n```\n\n# Notes and Errors\n\nI Run the job for the first time and i the job failed because it was out of memory. **(exit code 137).**\nI tried to increase the memory in the SBATCH directives in the step4_mriqc.sh file. I Tried with 100G. This did not work either\nJust for check i will run it for only the T1 images just to see what is going on. NOTE that the T1w are significantly smaller size that the bold. \nIf this does not work then there is definetely a problem. So this run correctly, i will now try for the bold to see if only the bold will be executed.\nBold job was again killed due to memory issues. What i will do next is to reduce to  --nprocs 8 and --omp-nthreads 4 (This setup means MRIQC will not use more than 8 processes at a time, and each process will use up to 2 threads if multi-threading is supported by the task). NOTE: This might considerably slow down the job.\nAnother solution would be to run MRIQC for each task seperetely as we did with T1w. **To be checked**\n\n - With these parameters above (--nprocs 8 and --omp-nthreads 4) it was executed succesfully. However, it took almost 2 hours for the bold images. It is worth trying submitting a unique job for each task in each modality as this could be faster. Another thing to try is play with the parameters. For instance, next we can try --nprocs 10 and --omp-nthreads 6 and if this works then double the original parameters\n \n \n# Scripts\n \n ``` {.bash filename=\"step4_mriqc.sh\" code-line-numbers=\"true\" code-fold=\"true\"}\n #!/bin/bash\n\n###############################\n### from https://bircibrain.github.io/computingguide/docs/fmri-preprocessing/mriqc.html#singularitystorrs-hpc\n### \n### Adapted for the CRNL \n### by Gaelle Leroux, PhD\n### and Isabelle Faillenot, PhD\n###\n### Fall 2020, Lyon\n### gaelle.leroux @ cnrs.fr\n###\n### launched by: sbatch step4_mriqc.sh ${subject} ${session_name} ${WD} ${my_study}\n###\n###############################\n#\n### The SBATCH directives for a sequential (email line 37 to be revised only):\n\n### Your job name displayed by the queue\n### use \"squeue\" command in a terminal to see it\n#SBATCH --job-name=mriQC\n\n### Specify output and error files\n### %A for job array's master job allocation number\n### or %a for job array ID (index) number\n#SBATCH --output=out_mriQC_%A.log\n#SBATCH --error=err_mriQC_%A.log\n\n### Specify the number of tasks, CPU per task and buffer size to be used\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=100G\n\n\n### Send email for which step: NONE, BEGIN, END, FAIL, REQUEUE, ALL\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=${firstName}.${lastName}@univ-lyon1.fr\n\n### The size of the participant table to be run\n###SBATCH --array=1-1\n\n### If you want to launch your script on a specific node of the cluser\n### If yes, uncomment the appropirate line(s) \n###SBATCH --nodelist=node9\n#SBATCH --exclude=node9\n###SBATCH --exclude=node[9-10]\n\n# End of the SBATCH directives\n###############################\n#\n# Paths of the study\nsubject=$1\nsession_name=$2\nWD=$3\nmy_study=$4\nSTUDY=${WD}/${my_study}\nDATA_DIRECTORY=${STUDY}\"/data\"\nOUTPUT_DIRECTORY=${DATA_DIRECTORY}\"/bids\"\n#\nMRIQC_SINGULARITY_IMG=\"/mnt/data/soft/Images/mriqc_23.1.0.sif\"\n#\n## Comment: Parse the participants.tsv file and extract one subject ID from the line corresponding to this SLURM task.\n## Comment: 1 line below to uncomment if you want to launch the script for all the subjects listed in ${DATA_DIRECTORY}/participants.tsv\n#subject=$( sed -n -E \"$((${SLURM_ARRAY_TASK_ID} + 1))s/sub-(\\S*)\\>.*/\\1/gp\" ${DATA_DIRECTORY}/participants.tsv )\n#\n###############################\n#\n# To be printed in the out_mriQC_*.log file :\necho \"#########################################################################\"\necho \"USER:\" $USER\necho \"#\"\necho \"SLURM_SUBMITING_DIRECTORY:\" $SLURM_SUBMIT_DIR\necho \"SLURM_JOB_NODELIST:\" $SLURM_NODELIST\necho \"SLURM_JOB_NAME:\" $SLURM_JOB_NAME\necho \"SLURM_JOB_ID:\" $SLURM_JOBID\necho \"SLURM_ARRAY_TASK_ID:\" $SLURM_ARRAY_TASK_ID\necho \"SLURM_NTASKS:\" $SLURM_NTASKS\necho \"#\"\necho \"Step 4: Control of the quality of images using mriQC BIDSapp\"\necho \"#\"\necho \"Subject:\" ${subject}\necho \"Session:\" ${session_name}\necho \"#\"\necho \"Job STARTED @ $(date)\"\necho \"#\"\n#\n# PREREQUISITE: a dataset organised according to BIDS standards.\n# NOW: submission to slurm workload manager and run a singularity image for mriQC \n#\n# Compose the command line\n#\n# Note that this is only for one modality for a check! REMEMBER to change it afterwards to run all modalities\n######## PLAYING WITH THE --nprocs and --omp-nthreads 4 to find the sweet spot remember to change that\n\n\ncmd=\"srun singularity run \\\n\t--cleanenv \\\n\t--bind ${STUDY}:/base --bind ${DATA_DIRECTORY}:/data --bind ${OUTPUT_DIRECTORY}:/out \\\n\t${MRIQC_SINGULARITY_IMG} \\\n\t/data/bids /out/derivatives/mriqc participant \\\n\t--participant-label ${subject} \\\n\t--modalities bold \\\n\t--work-dir /base/code/logs/mriqc_intermediate_results_${subject} \\\n\t--mem 96 \\\n    --nprocs 8 \\\n    --omp-nthreads 4 \\\n\t--profile \\\n\t--verbose-reports \\\n\t--write-graph \\\n\t--fft-spikes-detector\"\n\n# Setup done, run the command\necho \"Command line used (example of the last subject processed)\"\necho $cmd\necho \"#\"\n#\neval $cmd\nexitcode=$?\n#\necho \"#\"\necho \"Job STOPPED @ $(date)\"\necho \"#\"\necho \"If MRIQC successful, the last end of the out*.log file is:\"\necho \"<Participant level finished successfully> Otherwise, a problem occured.\"\necho \"#\"\necho \"Check that \"$OUTPUT_DIRECTORY\"/derivatives/mriqc and mriqc_working_directory\"\necho \"folders have been created & look at all reports created.\"\necho \"############################################################################################\"\necho \"#\"\n# Output results to a table\necho \"sub-${subject}\t${SLURM_ARRAY_TASK_ID}\t$exitcode\" >> ${SLURM_JOB_NAME}.step4.${SLURM_ARRAY_JOB_ID}.tsv\necho Finished tasks ${SLURM_ARRAY_TASK_ID} with exit code $exitcode\nexit $exitcode\n```","srcMarkdownNoYaml":"\n\n# Set up \nIn this preliminary step we setup and define our variables. Note from the code below, change the variable “subject” to the subject you are working on. The Tiger notation is C for controls and G for Gamblers, e.g. for the first control subject the notation is C01 and for the first gambler G01. The following procedure is to submit the job for one subject. (to be updated for more).\n\n``` bash\n# Standard variable for the Tiger study\nWD=/crnldata/psyr2/Anastasios/Tiger_fmri\nmy_study=Tiger\nsession_name=S01\n\n# change this to the subject you are working on\nsubject=XXX \n```\n\n# Submit the job\n\nRun the following code to submit the job to the cluster. This is for one subject only. There are scripts for multiple subjects via Slurm array jobs. (To be updated)\n\n``` bash\n# Submit the job\ncd ${WD}/${my_study}/code\nsbatch step4_mriqc.sh ${subject} ${session_name} ${WD} ${my_study}\nsqueue\n```\n\n# Notes and Errors\n\nI Run the job for the first time and i the job failed because it was out of memory. **(exit code 137).**\nI tried to increase the memory in the SBATCH directives in the step4_mriqc.sh file. I Tried with 100G. This did not work either\nJust for check i will run it for only the T1 images just to see what is going on. NOTE that the T1w are significantly smaller size that the bold. \nIf this does not work then there is definetely a problem. So this run correctly, i will now try for the bold to see if only the bold will be executed.\nBold job was again killed due to memory issues. What i will do next is to reduce to  --nprocs 8 and --omp-nthreads 4 (This setup means MRIQC will not use more than 8 processes at a time, and each process will use up to 2 threads if multi-threading is supported by the task). NOTE: This might considerably slow down the job.\nAnother solution would be to run MRIQC for each task seperetely as we did with T1w. **To be checked**\n\n - With these parameters above (--nprocs 8 and --omp-nthreads 4) it was executed succesfully. However, it took almost 2 hours for the bold images. It is worth trying submitting a unique job for each task in each modality as this could be faster. Another thing to try is play with the parameters. For instance, next we can try --nprocs 10 and --omp-nthreads 6 and if this works then double the original parameters\n \n \n# Scripts\n \n ``` {.bash filename=\"step4_mriqc.sh\" code-line-numbers=\"true\" code-fold=\"true\"}\n #!/bin/bash\n\n###############################\n### from https://bircibrain.github.io/computingguide/docs/fmri-preprocessing/mriqc.html#singularitystorrs-hpc\n### \n### Adapted for the CRNL \n### by Gaelle Leroux, PhD\n### and Isabelle Faillenot, PhD\n###\n### Fall 2020, Lyon\n### gaelle.leroux @ cnrs.fr\n###\n### launched by: sbatch step4_mriqc.sh ${subject} ${session_name} ${WD} ${my_study}\n###\n###############################\n#\n### The SBATCH directives for a sequential (email line 37 to be revised only):\n\n### Your job name displayed by the queue\n### use \"squeue\" command in a terminal to see it\n#SBATCH --job-name=mriQC\n\n### Specify output and error files\n### %A for job array's master job allocation number\n### or %a for job array ID (index) number\n#SBATCH --output=out_mriQC_%A.log\n#SBATCH --error=err_mriQC_%A.log\n\n### Specify the number of tasks, CPU per task and buffer size to be used\n#SBATCH --nodes=1\n#SBATCH --ntasks=1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=100G\n\n\n### Send email for which step: NONE, BEGIN, END, FAIL, REQUEUE, ALL\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=${firstName}.${lastName}@univ-lyon1.fr\n\n### The size of the participant table to be run\n###SBATCH --array=1-1\n\n### If you want to launch your script on a specific node of the cluser\n### If yes, uncomment the appropirate line(s) \n###SBATCH --nodelist=node9\n#SBATCH --exclude=node9\n###SBATCH --exclude=node[9-10]\n\n# End of the SBATCH directives\n###############################\n#\n# Paths of the study\nsubject=$1\nsession_name=$2\nWD=$3\nmy_study=$4\nSTUDY=${WD}/${my_study}\nDATA_DIRECTORY=${STUDY}\"/data\"\nOUTPUT_DIRECTORY=${DATA_DIRECTORY}\"/bids\"\n#\nMRIQC_SINGULARITY_IMG=\"/mnt/data/soft/Images/mriqc_23.1.0.sif\"\n#\n## Comment: Parse the participants.tsv file and extract one subject ID from the line corresponding to this SLURM task.\n## Comment: 1 line below to uncomment if you want to launch the script for all the subjects listed in ${DATA_DIRECTORY}/participants.tsv\n#subject=$( sed -n -E \"$((${SLURM_ARRAY_TASK_ID} + 1))s/sub-(\\S*)\\>.*/\\1/gp\" ${DATA_DIRECTORY}/participants.tsv )\n#\n###############################\n#\n# To be printed in the out_mriQC_*.log file :\necho \"#########################################################################\"\necho \"USER:\" $USER\necho \"#\"\necho \"SLURM_SUBMITING_DIRECTORY:\" $SLURM_SUBMIT_DIR\necho \"SLURM_JOB_NODELIST:\" $SLURM_NODELIST\necho \"SLURM_JOB_NAME:\" $SLURM_JOB_NAME\necho \"SLURM_JOB_ID:\" $SLURM_JOBID\necho \"SLURM_ARRAY_TASK_ID:\" $SLURM_ARRAY_TASK_ID\necho \"SLURM_NTASKS:\" $SLURM_NTASKS\necho \"#\"\necho \"Step 4: Control of the quality of images using mriQC BIDSapp\"\necho \"#\"\necho \"Subject:\" ${subject}\necho \"Session:\" ${session_name}\necho \"#\"\necho \"Job STARTED @ $(date)\"\necho \"#\"\n#\n# PREREQUISITE: a dataset organised according to BIDS standards.\n# NOW: submission to slurm workload manager and run a singularity image for mriQC \n#\n# Compose the command line\n#\n# Note that this is only for one modality for a check! REMEMBER to change it afterwards to run all modalities\n######## PLAYING WITH THE --nprocs and --omp-nthreads 4 to find the sweet spot remember to change that\n\n\ncmd=\"srun singularity run \\\n\t--cleanenv \\\n\t--bind ${STUDY}:/base --bind ${DATA_DIRECTORY}:/data --bind ${OUTPUT_DIRECTORY}:/out \\\n\t${MRIQC_SINGULARITY_IMG} \\\n\t/data/bids /out/derivatives/mriqc participant \\\n\t--participant-label ${subject} \\\n\t--modalities bold \\\n\t--work-dir /base/code/logs/mriqc_intermediate_results_${subject} \\\n\t--mem 96 \\\n    --nprocs 8 \\\n    --omp-nthreads 4 \\\n\t--profile \\\n\t--verbose-reports \\\n\t--write-graph \\\n\t--fft-spikes-detector\"\n\n# Setup done, run the command\necho \"Command line used (example of the last subject processed)\"\necho $cmd\necho \"#\"\n#\neval $cmd\nexitcode=$?\n#\necho \"#\"\necho \"Job STOPPED @ $(date)\"\necho \"#\"\necho \"If MRIQC successful, the last end of the out*.log file is:\"\necho \"<Participant level finished successfully> Otherwise, a problem occured.\"\necho \"#\"\necho \"Check that \"$OUTPUT_DIRECTORY\"/derivatives/mriqc and mriqc_working_directory\"\necho \"folders have been created & look at all reports created.\"\necho \"############################################################################################\"\necho \"#\"\n# Output results to a table\necho \"sub-${subject}\t${SLURM_ARRAY_TASK_ID}\t$exitcode\" >> ${SLURM_JOB_NAME}.step4.${SLURM_ARRAY_JOB_ID}.tsv\necho Finished tasks ${SLURM_ARRAY_TASK_ID} with exit code $exitcode\nexit $exitcode\n```"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"self-contained":true,"output-file":"run_mriqc.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","theme":"cosmo","title":"Run MRIQC in CRNL cluster","author":"Anastasios Dadiotis","editor":"visual"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}